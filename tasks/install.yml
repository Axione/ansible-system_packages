---
### REDHAT families Install repositories
- name: "REDHAT | Install extra repositories"
  when: ansible_os_family in ["RedHat", "Rocky", "OracleLinux"]
  block:
    - name: "Check if EPEL repo is already configured"
      stat:
        path: "/etc/yum.repos.d/epel.repo"
      register: epel_repo

    - name: "REDHAT | Import EPEL GPG key."
      ansible.builtin.rpm_key:
        key: "https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-{{ ansible_distribution_major_version }}"
        state: present
      when: not epel_repo.stat.exists

    - name: "REDHAT | Installing epel-release"
      ansible.builtin.yum:
        name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
      when: not epel_repo.stat.exists

    - name: "OracleLinux | Installing oracle-epel-release-el7"
      ansible.builtin.yum:
        name: "oracle-epel-release-el7"
        state: present
      when: ansible_distribution == "OracleLinux" and ansible_distribution_major_version == "7"

- name: "DEBIAN | Install packages"
  ansible.builtin.package:
    name: "{{ packages_common  + packages_family + packages_distrib + packages_distrib_version + packages_extra }}"
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: "REDHAT | Install packages"
  ansible.builtin.yum:
    name: "{{ packages_common  + packages_family + packages_distrib + packages_distrib_version + packages_extra }}"
    state: present
  when: ansible_os_family in ["RedHat", "Rocky", "OracleLinux"]

- name: "DEBIAN | Remove packages"
  ansible.builtin.package:
    name: "{{ packages_rm_common  + packages_rm_family + packages_rm_distrib + packages_rm_distrib_version + packages_rm_extra }}"
    state: absent
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: "REDHAT | Remove packages"
  ansible.builtin.yum:
    name: "{{ packages_rm_common  + packages_rm_family + packages_rm_distrib + packages_rm_distrib_version + packages_rm_extra }}"
    state: absent
  when: ansible_os_family in ["RedHat", "Rocky", "OracleLinux"]

- name: "REDHAT | Remove packages relationship"
  ansible.builtin.shell: yum remove -y `package-cleanup --leaves`
  with_sequence: count=3
  changed_when: false
  when: ansible_os_family in ["RedHat", "Rocky", "OracleLinux"]

- name: "REDHAT | Packages clean all"
  ansible.builtin.shell: yum clean all && rm -rf /var/cache/yum
  changed_when: false
  when: ansible_os_family in ["RedHat", "Rocky", "OracleLinux"]
